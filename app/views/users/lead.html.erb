<div class="container lead-container" data-controller="lead-swipe">

  <!-- MATCH POPUP -->
  <% if @match %>
    <div class="match-popup" data-match-popup>
      <div class="match-popup-content">
        <div class="match-animation">
          <span class="match-icon">üíï</span>
        </div>
        <h2 class="match-title">Deu Match!</h2>
        <p class="match-subtitle">Voc√™ e <strong><%= @next_user.display_name %></strong> curtiram um ao outro!</p>
        <p class="match-description">Deseja iniciar uma conversa agora?</p>

        <div class="match-actions">
          <%= link_to "üí¨ Conversar Agora", match_path(@match), class: "btn btn-match btn-primary" %>
          <%= link_to "‚û° Continuar Vendo", lead_path, class: "btn btn-match btn-secondary" %>
        </div>
      </div>
      <div class="match-overlay"></div>
    </div>
  <% end %>

  <!-- HEADER -->
  <div class="lead-header">
    <h1 class="lead-title">Descubra Pessoas Pr√≥ximas</h1>
    <p class="lead-subtitle">Deslize para rejeitar ou curtir</p>
  </div>

  <% if @next_user %>
    <!-- LEAD CARD PRINCIPAL -->
    <div
  class="lead-card-wrapper"
  data-lead-card
  data-user-id="<%= @next_user.id %>"
    >
      
      <!-- GALERIA DE FOTOS -->
      <div class="lead-gallery">
        <div class="gallery-container">
          <% album_photos = @next_user.album_photos.attached? ? @next_user.album_photos : [] %>
          <% avatar = @next_user.avatar.attached? %>
          
          <% if album_photos.any? || avatar %>
            <% photos = [] %>
            <% if avatar %>
              <% photos << { url: rails_blob_url(@next_user.avatar), type: 'avatar' } %>
            <% end %>
            <% album_photos.each do |photo| %>
              <% photos << { url: rails_blob_url(photo), type: 'album' } %>
            <% end %>

            <!-- IMAGENS DO CARROSSEL -->
            <div class="gallery-slides" data-gallery-slides>
              <% photos.each_with_index do |photo, index| %>
                <div class="gallery-slide <%= 'active' if index == 0 %>" data-slide-index="<%= index %>">
                  <img src="<%= photo[:url] %>" alt="Foto <%= index + 1 %>" class="gallery-image" loading="lazy">
                  <div class="gallery-overlay"></div>
                </div>
              <% end %>
            </div>

            <!-- INDICADOR DE PROGRESSO (DOTS) -->
            <div class="gallery-indicators">
              <% photos.each_with_index do |_, index| %>
                <div class="indicator <%= 'active' if index == 0 %>" data-indicator-index="<%= index %>"></div>
              <% end %>
            </div>

            <!-- NAVEGA√á√ÉO DE FOTOS (SETAS) -->
            <% if photos.length > 1 %>
              <button class="gallery-nav gallery-prev" data-gallery-prev aria-label="Foto anterior">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button class="gallery-nav gallery-next" data-gallery-next aria-label="Pr√≥xima foto">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            <% end %>
          <% else %>
            <!-- FALLBACK SE N√ÉO HOUVER FOTOS -->
            <div class="gallery-fallback">
              <div class="fallback-avatar">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                  <line x1="9" y1="9" x2="9.01" y2="9"></line>
                  <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
              </div>
              <p>Sem fotos dispon√≠veis</p>
            </div>
          <% end %>
        </div>

        <!-- INDICADOR DE SWIPE -->
        <div class="swipe-indicator" data-swipe-indicator>
          <div class="swipe-left">
            <span class="swipe-icon">‚ùå</span>
            <span class="swipe-text">Rejeitar</span>
          </div>
          <div class="swipe-right">
            <span class="swipe-icon">‚ù§Ô∏è</span>
            <span class="swipe-text">Curtir</span>
          </div>
        </div>
      </div>

      <!-- INFORMA√á√ïES DO USU√ÅRIO -->
      <div class="lead-info">
        <div class="user-header">
          <h2 class="user-name">
            <%= @next_user.display_name %>
            <% if @next_user.respond_to?(:verified) && @next_user.verified %>
              <span class="verified-badge" title="Perfil verificado">‚úì</span>
            <% end %>
          </h2>
          <p class="user-location">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <% if @distance %>
              <strong><%= @distance %> km</strong> de voc√™
            <% end %>
          </p>
        </div>

        <!-- BIO -->
        <% if @next_user.bio.present? %>
          <div class="user-bio">
            <p><%= @next_user.bio %></p>
          </div>
        <% end %>

        <!-- HOBBIES -->
        <% if @next_user.hobbies_list.any? %>
          <div class="user-hobbies">
            <h6 class="hobbies-title">Interesses</h6>
            <div class="hobbies-list">
              <% @next_user.hobbies_list.each do |hobby| %>
                <span class="hobby-badge"><%= hobby %></span>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- INFORMA√á√ïES ADICIONAIS -->
        <div class="user-meta">
          <% if @next_user.age.present? %>
            <div class="meta-item">
              <span class="meta-label">Idade:</span>
              <span class="meta-value"><%= @next_user.age %> anos</span>
            </div>
          <% end %>
          <% if @next_user.city.present? %>
            <div class="meta-item">
              <span class="meta-label">Cidade:</span>
              <span class="meta-value"><%= @next_user.city %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- BOT√ïES DE A√á√ÉO (FALLBACK PARA DESKTOP) -->
    <div class="lead-actions-desktop">
      <%# REJEITAR: Usa button_to para garantir que o POST seja enviado corretamente %>
      <%= button_to reject_user_path(user_id: @next_user.id), method: :post, class: "action-button reject-button", title: "Rejeitar (ou deslize para esquerda)" do %>
        <span class="button-icon">‚ùå</span>
        <span class="button-text">Rejeitar</span>
      <% end %>

      <%# CURTIR: Usa button_to para garantir que o POST seja enviado corretamente %>
      <%= button_to likes_path(user_id: @next_user.id), method: :post, class: "action-button like-button", title: "Curtir (ou deslize para direita)" do %>
        <span class="button-icon">‚ù§Ô∏è</span>
        <span class="button-text">Curtir</span>
      <% end %>
    </div>

  <% else %>
    <!-- ESTADO VAZIO -->
    <div class="lead-empty">
      <div class="empty-icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
          <line x1="9" y1="9" x2="9.01" y2="9"></line>
          <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
      </div>
      <h3 class="empty-title">Sem mais usu√°rios</h3>
      <p class="empty-message">N√£o h√° mais usu√°rios eleg√≠veis no momento.</p>
      <p class="empty-submessage">Tente novamente mais tarde ou ajuste seus filtros.</p>
      <%= link_to "‚Üê Voltar", discover_path, class: "btn btn-outline-primary mt-3" %>
    </div>
  <% end %>
</div>
