<div class="chat-wrapper">
  <div class="chat-container">

    <!-- Chat Header -->
    <div class="chat-header">
      <div class="header-content">
        <div class="header-back">
          <%= link_to matches_path, class: "back-link" do %>
            <span class="back-icon">â†</span>
          <% end %>
        </div>

        <div class="header-user">
          <% other_user = @match.other_user(current_user) %>

          <% if other_user.avatar.attached? %>
            <%= image_tag other_user.avatar, class: "header-avatar" %>
          <% else %>
            <div class="header-avatar-placeholder">
              <%= other_user.display_name[0].upcase rescue "?" %>
            </div>
          <% end %>

          <div class="header-info">
            <h2 class="header-name"><%= other_user.display_name %></h2>
            <p class="header-status">Ativo agora</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="chat-messages">
      <% if @messages.empty? %>
        <div class="messages-empty">
          <div class="empty-icon">ğŸ’¬</div>
          <p class="empty-text">Comece a conversa! Envie uma mensagem para <strong><%= other_user.display_name %></strong></p>
        </div>
      <% else %>
        <% @messages.each do |message| %>
          <div class="message-group <%= message.sender == current_user ? 'sent' : 'received' %>">
            <div class="message-bubble">
              <p class="message-text"><%= message.content %></p>
              <span class="message-time"><%= message.created_at.strftime("%H:%M") %></span>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Input -->
    <div class="chat-footer">
      <div class="message-form-wrapper">
        <%= form_with model: [@match, @message], local: true, class: "message-form", id: "message-form" do |f| %>
          <%= f.text_field :content,
              placeholder: "Digite uma mensagem...",
              class: "message-input",
              autocomplete: "off",
              id: "message-input" %>
          <%= f.submit "Enviar", class: "send-btn", id: "send-btn" %>
        <% end %>
      </div>
    </div>

  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const chatMessages = document.getElementById("chat-messages");
    const messageInput = document.getElementById("message-input");
    const messageForm = document.getElementById("message-form");

    const scrollToBottom = () => {
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 0);
    };

    scrollToBottom();
    messageInput.focus();

    messageForm.addEventListener("submit", () => {
      setTimeout(scrollToBottom, 100);
    });

    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        messageForm.submit();
      }
    });
  });
</script>
